<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backoffice - Administração</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #5624d0;
      --primary-dark: #401b9c;
      --secondary: #2d2f31;
      --text-primary: #1c1d1f;
      --text-secondary: #6a6f73;
      --border: #d1d7dc;
      --bg-light: #f7f9fa;
      --white: #ffffff;
      --success: #5cb85c;
      --danger: #ec5252;
      --warning: #f0ad4e;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
    }

    .header {
      background: var(--secondary);
      color: white;
      padding: 16px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
    }

    .stat-card i {
      font-size: 32px;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .stat-number {
      font-size: 36px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .section {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 15px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(86, 36, 208, 0.1);
    }

    .form-group small {
      display: block;
      margin-top: 6px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: var(--bg-light);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover {
      background: var(--bg-light);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      overflow-y: auto;
      padding: 40px 20px;
    }

    .modal.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 700px;
      width: 100%;
      margin: auto;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .modal-close:hover {
      background: var(--bg-light);
    }

    .modal-body {
      padding: 24px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .video-preview {
      width: 100%;
      height: 200px;
      background: var(--bg-light);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .video-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-preview i {
      font-size: 48px;
      color: var(--text-secondary);
    }

    .thumbnail-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .thumb-tab {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      font-weight: 500;
    }

    .thumb-tab:hover {
      color: var(--primary);
      background: var(--bg-light);
    }

    .thumb-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .thumb-tab-content {
      display: none;
      padding: 16px 0;
    }

    .thumb-tab-content.active {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .video-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .video-item-thumb {
      width: 120px;
      height: 80px;
      background: var(--bg-light);
      border-radius: 4px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .video-item-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-item-info {
      flex: 1;
    }

    .video-item-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .video-item-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .video-item-actions {
      display: flex;
      gap: 8px;
    }

    .trail-item {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .trail-item-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .trail-item-title {
      font-weight: 600;
      font-size: 18px;
    }

    .trail-item-description {
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .trail-videos-count {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-light);
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .student-table {
      margin-top: 24px;
    }

    .alert {
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--secondary);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      animation: slideInUp 0.3s ease;
      min-width: 280px;
      max-width: 400px;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    .toast i {
      font-size: 20px;
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideOutDown {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(100px);
        opacity: 0;
      }
    }

    .toast.hiding {
      animation: slideOutDown 0.3s ease;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-content {
      background: white;
      border-radius: 12px;
      padding: 32px 48px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .confirm-modal.active {
      display: flex;
    }

    .confirm-content {
      background: white;
      border-radius: 12px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .confirm-icon {
      font-size: 48px;
      color: var(--warning);
      margin-bottom: 16px;
    }

    .confirm-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .confirm-message {
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .confirm-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-container">
      <div class="header-title">
        <i class="fas fa-chart-line"></i>
        Backoffice - Administração
      </div>
      <div id="adminName"></div>
    </div>
  </div>

  <div class="container">
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <i class="fas fa-users"></i>
        <div class="stat-number" id="totalUsers">-</div>
        <div class="stat-label">Total de Alunos</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-video"></i>
        <div class="stat-number" id="totalVideos">-</div>
        <div class="stat-label">Total de Vídeos</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-route"></i>
        <div class="stat-number" id="totalTrails">-</div>
        <div class="stat-label">Trilhas Criadas</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-eye"></i>
        <div class="stat-number" id="totalViews">-</div>
        <div class="stat-label">Visualizações</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-clipboard-check"></i>
        <div class="stat-number" id="totalQuizzes">-</div>
        <div class="stat-label">Quizzes Completados</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-video"></i>
          Gerenciar Vídeos
        </h2>
        <button class="btn btn-primary" onclick="openAddVideoModal()">
          <i class="fas fa-plus"></i>
          Adicionar Vídeo
        </button>
      </div>
      <div id="videosList">
        <div class="loading">
          <div class="spinner"></div>
          Carregando vídeos...
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-route"></i>
          Gerenciar Trilhas
        </h2>
        <button class="btn btn-primary" onclick="openAddTrailModal()">
          <i class="fas fa-plus"></i>
          Criar Trilha
        </button>
      </div>
      <div id="trailsList">
        <div class="loading">
          <div class="spinner"></div>
          Carregando trilhas...
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-users"></i>
          Dashboard de Alunos
        </h2>
      </div>
      <div class="table-container student-table">
        <table>
          <thead>
            <tr>
              <th>Aluno</th>
              <th>Email</th>
              <th>Pontos</th>
              <th>Vídeos Assistidos</th>
            </tr>
          </thead>
          <tbody id="studentsTableBody">
            <tr>
              <td colspan="4" class="loading">Carregando alunos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="addVideoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="videoModalTitle">Adicionar Novo Vídeo</h3>
        <button class="modal-close" onclick="closeAddVideoModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editingVideoId" value="">
        
        <div class="video-preview" id="videoPreview">
          <i class="fas fa-image"></i>
        </div>
        
        <div class="form-group">
          <label>Título do Vídeo *</label>
          <input type="text" id="videoTitle" placeholder="Ex: Introdução ao Marketing Digital">
        </div>
        
        <div class="form-group">
          <label>URL ou ID do Vimeo *</label>
          <input type="text" id="videoVimeoId" placeholder="Cole a URL completa ou apenas o ID">
          <small>Exemplo: https://vimeo.com/123456789 ou apenas 123456789</small>
        </div>
        
        <div class="form-group">
          <label>Thumbnail</label>
          <div class="thumbnail-tabs">
            <button type="button" class="thumb-tab active" onclick="switchThumbTab('auto')">
              <i class="fas fa-magic"></i> Buscar Automático
            </button>
            <button type="button" class="thumb-tab" onclick="switchThumbTab('url')">
              <i class="fas fa-link"></i> URL Manual
            </button>
            <button type="button" class="thumb-tab" onclick="switchThumbTab('upload')">
              <i class="fas fa-upload"></i> Upload Imagem
            </button>
          </div>
          
          <div id="thumbTabAuto" class="thumb-tab-content active">
            <p style="margin: 12px 0; color: var(--text-secondary); font-size: 14px;">
              <i class="fas fa-info-circle"></i> Clique para buscar a thumbnail direto do Vimeo
            </p>
            <button type="button" class="btn btn-secondary" onclick="fetchAutoThumbnail()" style="width: 100%;">
              <i class="fas fa-download"></i> Buscar Thumbnail do Vimeo
            </button>
          </div>
          
          <div id="thumbTabUrl" class="thumb-tab-content">
            <input type="url" id="videoThumbnail" placeholder="https://exemplo.com/imagem.jpg" onchange="updateVideoPreview()">
            <small>Cole a URL da imagem de capa do vídeo</small>
          </div>
          
          <div id="thumbTabUpload" class="thumb-tab-content">
            <input type="file" id="thumbnailFile" accept="image/*" onchange="handleThumbnailUpload()" style="margin-bottom: 12px;">
            <small><i class="fas fa-info-circle"></i> A imagem será enviada para o GitHub e um link público será gerado</small>
          </div>
        </div>
        
        <div class="form-group">
          <label>Descrição</label>
          <textarea id="videoDescription" rows="4" placeholder="Descreva o conteúdo do vídeo"></textarea>
        </div>
        
        <button class="btn btn-primary" onclick="saveVideo()">
          <i class="fas fa-save"></i>
          <span id="saveButtonText">Salvar Vídeo</span>
        </button>
      </div>
    </div>
  </div>

  <div id="addTrailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Criar Nova Trilha</h3>
        <button class="modal-close" onclick="closeAddTrailModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nome da Trilha *</label>
          <input type="text" id="trailName" placeholder="Ex: Fundamentos de Marketing">
        </div>
        <div class="form-group">
          <label>Descrição</label>
          <textarea id="trailDescription" rows="3" placeholder="Descreva o objetivo desta trilha"></textarea>
        </div>
        <div class="form-group">
          <label>Selecione os Vídeos *</label>
          <select id="trailVideos" multiple size="8">
          </select>
          <small>Segure Ctrl/Cmd para selecionar múltiplos vídeos. A ordem de seleção será preservada.</small>
        </div>
        <button class="btn btn-primary" onclick="addTrail()">
          <i class="fas fa-save"></i>
          Criar Trilha
        </button>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Processando...</div>
    </div>
  </div>

  <div id="confirmModal" class="confirm-modal">
    <div class="confirm-content">
      <div class="confirm-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="confirm-title" id="confirmTitle">Confirmar Ação</div>
      <div class="confirm-message" id="confirmMessage">Tem certeza?</div>
      <div class="confirm-actions">
        <button class="btn btn-sm" onclick="closeConfirm()" style="background: #6c757d; color: white;">Cancelar</button>
        <button class="btn btn-sm btn-danger" id="confirmButton" onclick="confirmAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    var allVideos = [];
    var allTrails = [];
    var currentUser = null;
    var confirmCallback = null;

    function showToast(message, type) {
      if (typeof type === 'undefined') type = 'success';
      
      var toastId = 'toast_' + Date.now();
      var toast = document.createElement('div');
      toast.id = toastId;
      toast.className = 'toast ' + type;
      
      var icon = type === 'success' ? 'check-circle' : 
                   type === 'error' ? 'exclamation-circle' : 
                   type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      
      toast.innerHTML = '<i class="fas fa-' + icon + '"></i>' +
        '<span>' + message + '</span>';
      
      document.body.appendChild(toast);
      
      setTimeout(function() {
        toast.classList.add('hiding');
        setTimeout(function() { toast.remove(); }, 300);
      }, 3000);
    }

    function showLoading(text) {
      if (typeof text === 'undefined') text = 'Processando...';
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    function showConfirm(title, message, callback) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      confirmCallback = callback;
      document.getElementById('confirmModal').classList.add('active');
    }

    function closeConfirm() {
      document.getElementById('confirmModal').classList.remove('active');
      confirmCallback = null;
    }

    function confirmAction() {
      if (confirmCallback) {
        confirmCallback();
      }
      closeConfirm();
    }

    window.onload = async function() {
      await loadCurrentUser();
      await loadMetrics();
      await loadVideos();
      await loadTrails();
      await loadStudents();
    };

    async function loadCurrentUser() {
      google.script.run.withSuccessHandler(function(user) {
        currentUser = user;
        document.getElementById('adminName').textContent = user.name;
      }).getCurrentUser();
    }

    async function loadMetrics() {
      google.script.run.withSuccessHandler(function(metrics) {
        document.getElementById('totalUsers').textContent = metrics.totalUsers;
        document.getElementById('totalVideos').textContent = metrics.totalVideos;
        document.getElementById('totalTrails').textContent = metrics.totalTrails;
        document.getElementById('totalViews').textContent = metrics.totalViews;
        document.getElementById('totalQuizzes').textContent = metrics.totalQuizzes;
      }).getAdminMetrics();
    }

    async function loadVideos() {
      google.script.run.withSuccessHandler(function(videos) {
        allVideos = videos;
        displayVideos(videos);
      }).getVideos();
    }

    function displayVideos(videos) {
      var container = document.getElementById('videosList');
      
      if (videos.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">' +
          '<i class="fas fa-info-circle"></i> ' +
          'Nenhum vídeo cadastrado ainda. Clique em "Adicionar Vídeo" para começar.' +
          '</div>';
        return;
      }
      
      var html = '';
      for (var i = 0; i < videos.length; i++) {
        var video = videos[i];
        var thumbHtml = video.thumbnail ? 
          '<img src="' + video.thumbnail + '" alt="' + video.title + '">' : 
          '<i class="fas fa-video" style="padding: 30px; font-size: 24px; color: var(--text-secondary);"></i>';
        
        html += '<div class="video-item">' +
          '<div class="video-item-thumb">' + thumbHtml + '</div>' +
          '<div class="video-item-info">' +
            '<div class="video-item-title">' + video.title + '</div>' +
            '<div class="video-item-meta">' +
              '<i class="fas fa-eye"></i> ' + video.views + ' visualizações' +
              '<span style="margin: 0 8px;">•</span>' +
              '<i class="fas fa-heart"></i> ' + video.likes + ' curtidas' +
              '<span style="margin: 0 8px;">•</span>' +
              'ID: ' + video.vimeoId +
            '</div>' +
          '</div>' +
          '<div class="video-item-actions">' +
            '<button class="btn btn-primary btn-sm" onclick="openEditVideoModal(\'' + video.id + '\')" style="margin-right: 8px;">' +
              '<i class="fas fa-edit"></i>' +
            '</button>' +
            '<button class="btn btn-danger btn-sm" onclick="deleteVideo(\'' + video.id + '\')">' +
              '<i class="fas fa-trash"></i>' +
            '</button>' +
          '</div>' +
        '</div>';
      }
      
      container.innerHTML = html;
    }

    function openAddVideoModal() {
      document.getElementById('videoModalTitle').textContent = 'Adicionar Novo Vídeo';
      document.getElementById('saveButtonText').textContent = 'Salvar Vídeo';
      document.getElementById('editingVideoId').value = '';
      document.getElementById('addVideoModal').classList.add('active');
    }

    function openEditVideoModal(videoId) {
      var video = allVideos.find(function(v) { return v.id === videoId; });
      if (!video) return;
      
      document.getElementById('videoModalTitle').textContent = 'Editar Vídeo';
      document.getElementById('saveButtonText').textContent = 'Atualizar Vídeo';
      document.getElementById('editingVideoId').value = videoId;
      
      document.getElementById('videoTitle').value = video.title;
      document.getElementById('videoVimeoId').value = video.vimeoId;
      document.getElementById('videoThumbnail').value = video.thumbnail || '';
      document.getElementById('videoDescription').value = video.description || '';
      
      if (video.thumbnail) {
        document.getElementById('videoPreview').innerHTML = '<img src="' + video.thumbnail + '" alt="Preview">';
      }
      
      document.getElementById('addVideoModal').classList.add('active');
    }

    function closeAddVideoModal() {
      document.getElementById('addVideoModal').classList.remove('active');
      document.getElementById('editingVideoId').value = '';
      document.getElementById('videoTitle').value = '';
      document.getElementById('videoVimeoId').value = '';
      document.getElementById('videoThumbnail').value = '';
      document.getElementById('videoDescription').value = '';
      document.getElementById('videoPreview').innerHTML = '<i class="fas fa-image"></i>';
      if (document.getElementById('thumbnailFile')) {
        document.getElementById('thumbnailFile').value = '';
      }
      switchThumbTab('auto');
    }

    function switchThumbTab(tab) {
      var tabs = document.querySelectorAll('.thumb-tab');
      var contents = document.querySelectorAll('.thumb-tab-content');
      
      tabs.forEach(function(btn) {
        btn.classList.remove('active');
      });
      contents.forEach(function(content) {
        content.classList.remove('active');
      });
      
      var clickedButton = window.event ? window.event.target : null;
      if (clickedButton) {
        clickedButton.classList.add('active');
      }
      
      var tabId = 'thumbTab' + tab.charAt(0).toUpperCase() + tab.slice(1);
      document.getElementById(tabId).classList.add('active');
    }

    function updateVideoPreview() {
      var thumbnail = document.getElementById('videoThumbnail').value;
      var preview = document.getElementById('videoPreview');
      
      if (thumbnail) {
        preview.innerHTML = '<img src="' + thumbnail + '" alt="Preview" onerror="this.parentElement.innerHTML=\'<i class=\\'fas fa-exclamation-triangle\\'></i>\'">';
      } else {
        preview.innerHTML = '<i class="fas fa-image"></i>';
      }
    }

    function fetchAutoThumbnail() {
      var vimeoId = document.getElementById('videoVimeoId').value;
      
      if (!vimeoId) {
        showToast('Por favor, preencha o ID do Vimeo primeiro', 'warning');
        return;
      }
      
      showLoading('Buscando thumbnail do Vimeo...');
      
      google.script.run
        .withSuccessHandler(function(thumbnailUrl) {
          hideLoading();
          document.getElementById('videoThumbnail').value = thumbnailUrl;
          document.getElementById('videoPreview').innerHTML = '<img src="' + thumbnailUrl + '" alt="Preview">';
          showToast('Thumbnail carregada com sucesso!');
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToast('Erro ao buscar thumbnail: ' + error.message, 'error');
        })
        .fetchVimeoThumbnail(vimeoId);
    }

    function handleThumbnailUpload() {
      var file = document.getElementById('thumbnailFile').files[0];
      
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showToast('Por favor, selecione uma imagem válida', 'warning');
        return;
      }
      
      showLoading('Fazendo upload da imagem...');
      
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64Image = e.target.result;
        var filename = 'thumb_' + Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9.]/g, '_');
        
        google.script.run
          .withSuccessHandler(function(publicUrl) {
            hideLoading();
            document.getElementById('videoThumbnail').value = publicUrl;
            document.getElementById('videoPreview').innerHTML = '<img src="' + publicUrl + '" alt="Preview">';
            showToast('Imagem enviada para o GitHub com sucesso!');
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showToast('Erro no upload: ' + error.message, 'error');
          })
          .uploadImageToGitHub(base64Image, filename);
      };
      
      reader.readAsDataURL(file);
    }

    function saveVideo() {
      var editingId = document.getElementById('editingVideoId').value;
      var title = document.getElementById('videoTitle').value;
      var vimeoId = document.getElementById('videoVimeoId').value;
      var thumbnail = document.getElementById('videoThumbnail').value;
      var description = document.getElementById('videoDescription').value;
      
      if (!title || !vimeoId) {
        showToast('Por favor, preencha todos os campos obrigatórios', 'warning');
        return;
      }
      
      var videoData = {
        title: title,
        vimeoId: vimeoId,
        thumbnail: thumbnail,
        description: description
      };
      
      if (editingId) {
        showLoading('Atualizando vídeo...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            showToast('Vídeo atualizado com sucesso!');
            closeAddVideoModal();
            loadVideos();
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showToast('Erro ao atualizar vídeo: ' + error.message, 'error');
            console.error(error);
          })
          .updateVideo(editingId, videoData);
      } else {
        showLoading('Salvando vídeo...');
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            showToast('Vídeo adicionado com sucesso!');
            closeAddVideoModal();
            loadVideos();
            loadMetrics();
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showToast('Erro ao salvar vídeo: ' + error.message, 'error');
            console.error(error);
          })
          .addVideo(videoData);
      }
    }

    async function deleteVideo(videoId) {
      showConfirm(
        'Excluir Vídeo',
        'Esta ação não pode ser desfeita. Deseja continuar?',
        function() {
          showLoading('Excluindo vídeo...');
          
          google.script.run.withSuccessHandler(function(result) {
            hideLoading();
            showToast('Vídeo excluído com sucesso!');
            loadVideos();
            loadMetrics();
          }).withFailureHandler(function(error) {
            hideLoading();
            showToast('Erro ao excluir vídeo. Tente novamente.', 'error');
            console.error(error);
          }).deleteVideo(videoId);
        }
      );
    }

    async function loadTrails() {
      google.script.run.withSuccessHandler(function(trails) {
        allTrails = trails;
        displayTrails(trails);
      }).getTrails();
    }

    function displayTrails(trails) {
      var container = document.getElementById('trailsList');
      
      if (trails.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">' +
          '<i class="fas fa-info-circle"></i> ' +
          'Nenhuma trilha criada ainda. Clique em "Criar Trilha" para começar.' +
          '</div>';
        return;
      }
      
      var html = '';
      for (var i = 0; i < trails.length; i++) {
        var trail = trails[i];
        html += '<div class="trail-item">' +
          '<div class="trail-item-header">' +
            '<div>' +
              '<div class="trail-item-title">' + trail.name + '</div>' +
              '<div class="trail-item-description">' + trail.description + '</div>' +
            '</div>' +
            '<button class="btn btn-danger btn-sm" onclick="deleteTrail(\'' + trail.id + '\')">' +
              '<i class="fas fa-trash"></i>' +
            '</button>' +
          '</div>' +
          '<div class="trail-videos-count">' +
            '<i class="fas fa-video"></i> ' +
            trail.totalVideos + ' vídeo' + (trail.totalVideos !== 1 ? 's' : '') +
          '</div>' +
        '</div>';
      }
      container.innerHTML = html;
    }

    function openAddTrailModal() {
      var select = document.getElementById('trailVideos');
      var html = '';
      for (var i = 0; i < allVideos.length; i++) {
        html += '<option value="' + allVideos[i].id + '">' + allVideos[i].title + '</option>';
      }
      select.innerHTML = html;
      
      document.getElementById('addTrailModal').classList.add('active');
    }

    function closeAddTrailModal() {
      document.getElementById('addTrailModal').classList.remove('active');
      document.getElementById('trailName').value = '';
      document.getElementById('trailDescription').value = '';
    }

    async function addTrail() {
      var name = document.getElementById('trailName').value;
      var description = document.getElementById('trailDescription').value;
      var select = document.getElementById('trailVideos');
      var options = select.selectedOptions;
      var videos = [];
      for (var i = 0; i < options.length; i++) {
        videos.push(options[i].value);
      }
      
      if (!name || videos.length === 0) {
        showToast('Por favor, preencha o nome e selecione pelo menos um vídeo', 'warning');
        return;
      }
      
      showLoading('Criando trilha...');
      
      google.script.run.withSuccessHandler(function(result) {
        hideLoading();
        showToast('Trilha criada com sucesso!');
        closeAddTrailModal();
        loadTrails();
        loadMetrics();
      }).withFailureHandler(function(error) {
        hideLoading();
        showToast('Erro ao criar trilha. Tente novamente.', 'error');
        console.error(error);
      }).addTrail({ name: name, description: description, videos: videos });
    }

    async function deleteTrail(trailId) {
      showConfirm(
        'Excluir Trilha',
        'Esta ação não pode ser desfeita. Deseja continuar?',
        function() {
          showLoading('Excluindo trilha...');
          
          google.script.run.withSuccessHandler(function(result) {
            hideLoading();
            showToast('Trilha excluída com sucesso!');
            loadTrails();
            loadMetrics();
          }).withFailureHandler(function(error) {
            hideLoading();
            showToast('Erro ao excluir trilha. Tente novamente.', 'error');
            console.error(error);
          }).deleteTrail(trailId);
        }
      );
    }

    async function loadStudents() {
      google.script.run.withSuccessHandler(function(students) {
        var tbody = document.getElementById('studentsTableBody');
        
        if (students.length === 0) {
          tbody.innerHTML = '<tr>' +
            '<td colspan="4" style="text-align: center; color: var(--text-secondary);">' +
              'Nenhum aluno cadastrado' +
            '</td>' +
          '</tr>';
          return;
        }
        
        var html = '';
        for (var i = 0; i < students.length; i++) {
          var student = students[i];
          html += '<tr>' +
            '<td><strong>' + student.name + '</strong></td>' +
            '<td>' + student.email + '</td>' +
            '<td><strong>' + student.points + '</strong> pontos</td>' +
            '<td>' + (student.videosWatched || 0) + ' vídeos</td>' +
          '</tr>';
        }
        tbody.innerHTML = html;
      }).getTopStudents(100);
    }
  </script>
</body>
</html>
